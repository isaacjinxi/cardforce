<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9986380390919018">
    <title>Product - Card Force</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9986380390919018"
     crossorigin="anonymous"></script>
    
    <script src="maintenance-mode.js"></script>
    <script src="outdated-mode.js"></script>
    <script src="admin-utils.js"></script>
    <script>
        // Handle malformed URLs that might cause 404 errors
        (function() {
            const path = window.location.pathname;
            
            // If the path is just a number (like /3), redirect to index
            if (path.match(/^\/\d+$/)) {
                console.log('Redirecting malformed URL:', path, 'to index.html');
                window.location.href = '/';
                return;
            }
            
            // If the path is just a single character or number, redirect to index
            if (path.match(/^\/[a-zA-Z0-9]$/)) {
                console.log('Redirecting single character URL:', path, 'to index.html');
                window.location.href = '/';
                return;
            }
        })();
    </script>
    <script type="module">
      // Firebase Configuration
      import { initializeApp, getApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, collection } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      const firebaseConfig = {
        apiKey: "AIzaSyCJNv4DDv8Gbvtw3zRzsvNk3xW3e2sog7k",
        authDomain: "card-force-472100.firebaseapp.com",
        projectId: "card-force-472100",
        storageBucket: "card-force-472100.firebasestorage.app",
        messagingSenderId: "91438507562",
        appId: "1:91438507562:web:85673cf7f40190f4310553",
        measurementId: "G-J2Q14Y5FXS"
      };

      // Initialize Firebase
      let app, db, auth;

      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
      } catch (error) {
        console.error('Firebase initialization error:', error);
        // Try to get existing instances if already initialized
        try {
          app = getApp();
          db = getFirestore(app);
          auth = getAuth(app);
        } catch (retryError) {
          console.error('Failed to get existing Firebase instances:', retryError);
        }
      }

      // Make Firebase functions globally available
      window.firebaseApp = app;
      window.db = db;
      window.auth = auth;
      window.GoogleAuthProvider = GoogleAuthProvider;
      window.doc = doc;
      window.setDoc = setDoc;
      window.getDoc = getDoc;
      window.getDocs = getDocs;
      window.addDoc = addDoc;
      window.updateDoc = updateDoc;
      window.deleteDoc = deleteDoc;
      window.onSnapshot = onSnapshot;
      window.query = query;
      window.where = where;
      window.orderBy = orderBy;
      window.collection = collection;

      // Firebase Collections
      const COLLECTIONS = {
        USERS: 'users',
        ORDERS: 'orders',
        CARTS: 'carts',
        PRODUCTS: 'products',
        ADDRESSES: 'addresses',
        REFUNDS: 'refunds',
        CHAT_MESSAGES: 'chatMessages'
      };

      // Firebase Helper Functions
      class FirebaseService {
        constructor() {
          this.isInitialized = false;
          this.currentUser = null;
          this.init();
        }

        async init() {
          try {
            // Check for existing Google OAuth user in localStorage
            const googleUser = localStorage.getItem('googleUser');
            if (googleUser) {
              const userData = JSON.parse(googleUser);
              // Create a mock currentUser object for FirebaseService
              this.currentUser = {
                uid: userData.sub,
                email: userData.email,
                displayName: userData.name,
                photoURL: userData.picture
              };
              this.isInitialized = true;
              console.log('Firebase service initialized with existing Google user:', this.currentUser.uid);
              this.syncUserData(this.currentUser);
              return;
            }

            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
              this.currentUser = user;
              this.isInitialized = true;
              
              if (user) {
                console.log('Firebase user signed in:', user.uid);
                this.syncUserData(user);
              } else {
                console.log('Firebase user signed out');
              }
            });
          } catch (error) {
            console.error('Firebase initialization error:', error);
          }
        }

        // Product Management
        async loadProductsFromFirebase() {
          try {
            const querySnapshot = await getDocs(collection(db, COLLECTIONS.PRODUCTS));
            const products = [];
            querySnapshot.forEach((doc) => {
              products.push({ id: doc.id, ...doc.data() });
            });
            return products;
          } catch (error) {
            console.error('Error loading products from Firebase:', error);
            return [];
          }
        }

        async syncUserData(user) {
          try {
            const userRef = doc(db, COLLECTIONS.USERS, user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
              // Create new user document
              await setDoc(userRef, {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
              });
            } else {
              // Update last login
              await updateDoc(userRef, {
                lastLogin: new Date().toISOString()
              });
            }
          } catch (error) {
            console.error('Error syncing user data:', error);
          }
        }
      }
      
      // Initialize Firebase Service
      window.firebaseService = new FirebaseService();
      window.COLLECTIONS = COLLECTIONS;
      
      // Load product data from Firebase after initialization
      setTimeout(async () => {
        console.log('🔄 Product Page: Attempting to load product data from Firebase...');
        
        // Ensure Firebase service is initialized
        const googleUser = localStorage.getItem('googleUser');
        if (googleUser && !window.firebaseService?.currentUser) {
          console.log('🔄 Product Page: Initializing Firebase service with Google user...');
          const userData = JSON.parse(googleUser);
          window.firebaseService.currentUser = {
            uid: userData.sub,
            email: userData.email,
            displayName: userData.name,
            photoURL: userData.picture
          };
          window.firebaseService.isInitialized = true;
        }
        
        if (window.loadProductDataFromFirebase) {
          await window.loadProductDataFromFirebase();
        }
        
        // Set up real-time listener for product changes
        if (window.setupProductDataListener) {
          window.setupProductDataListener();
        }
      }, 2000);
      
      // Listen for product data updates
      window.addEventListener('productDataUpdated', () => {
        console.log('📡 Product Page: Product data updated, refreshing display...');
        // Refresh the product display
        if (typeof loadProduct === 'function') {
          loadProduct();
        }
      });
    </script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Raleway', sans-serif; background:#fff; color:#333; }
        .navbar { background: linear-gradient(135deg, #6a4c93, #8e44ad); padding: 0.5rem 0; position: sticky; top:0; z-index:1000; }
        .nav-container { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:0 1.25rem; position:relative; }
        .logo { color:#fff; text-decoration:none; font-weight:700; font-size:1.4rem; display:flex; align-items:center; gap:10px; }
        .logo-icon { width:40px; height:48px; background:#2c2c2c; border:3px solid #1a1a1a; border-radius:8px; position:relative; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow:hidden; }
        .logo-text { color:#fff; font-size:0.6rem; font-weight:800; line-height:0.8; text-align:center; }
        .logo-divider { width:24px; height:2px; background:#1a1a1a; margin:2px 0; }
        .nav-menu { display:flex; list-style:none; gap:1rem; }
        .nav-menu a { color:#fff; text-decoration:none; padding:0.35rem 0.75rem; border-radius:25px; transition:all 0.3s ease; font-weight:500; }
        .nav-menu a:hover { background-color:rgba(255,255,255,0.2); transform:translateY(-2px) scale(1.05); box-shadow:0 4px 8px rgba(106,76,147,0.4); }
        .main { max-width:1200px; margin:0 auto; padding:2rem; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:2rem; }
        .imgwrap { border:1px solid #eee; border-radius:12px; overflow:hidden; display:flex; flex-direction: column; align-items:center; justify-content:center; min-height:380px; }
        .image-gallery { position: relative; width: 100%; display: flex; align-items: center; justify-content: center; min-height: 350px; }
        .imgwrap img { max-width:100%; max-height:100%; object-fit:contain; }
        .gallery-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(106, 76, 147, 0.8); color: white; border: none; padding: 16px 12px; cursor: pointer; font-size: 18px; border-radius: 4px; transition: all 0.3s; z-index: 10; }
        .gallery-arrow:hover { background: rgba(106, 76, 147, 1); }
        .gallery-arrow-left { left: 10px; }
        .gallery-arrow-right { right: 10px; }
        .image-thumbnails { display: flex; gap: 8px; padding: 10px; justify-content: center; flex-wrap: wrap; }
        .thumbnail { width: 60px; height: 60px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; object-fit: cover; transition: all 0.2s; }
        .thumbnail:hover { border-color: #6a4c93; }
        .thumbnail.active { border-color: #6a4c93; border-width: 3px; }
        .title { font-size:2rem; font-weight:800; color:#6a4c93; margin-bottom:0.5rem; }
        .price { font-size:1.4rem; font-weight:700; color:#8e44ad; margin-bottom:0.25rem; }
        .discount-chip { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; background:#dc3545; color:#fff; font-size:0.75rem; font-weight:700; }
        .price-extra { font-size:0.95rem; color:#333; margin-bottom:0.75rem; }
        .desc { color:#555; margin:1rem 0; line-height:1.6; }
        .meta { color:#666; font-size:0.9rem; margin:0.5rem 0; }
        .actions { display:flex; gap:0.75rem; margin-top:1rem; }
        .btn { border:none; padding:0.8rem 1.2rem; border-radius:25px; font-weight:600; cursor:pointer; transition:.2s; }
        .btn.buy { background: linear-gradient(135deg, #6a4c93, #8e44ad); color:#fff; }
        .btn.cart { background: linear-gradient(135deg, #28a745, #20c997); color:#fff; }
        .disabled-btn { background:#b0b0b0 !important; color:#eee !important; cursor:not-allowed !important; }
        .stock { font-size:0.9rem; color:#666; margin-top:0.5rem; font-style:italic; }
        .footer { background: linear-gradient(135deg, #6a4c93, #8e44ad); color:#fff; text-align:center; padding:2rem 0; margin-top:3rem; }

        .database-down-banner {
            background: #ffc107;
            color: #212529;
            padding: 12px 20px;
            margin: 0;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid #e0a800;
            position: relative;
            z-index: 100;
        }
        .database-down-text {
            text-align: center;
            line-height: 1.4;
            max-width: 1200px;
            margin: 0 auto;
        }
    </style>
    </head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <div class="logo-text">
                        <div>CARD</div>
                        <div class="logo-divider"></div>
                        <div>FORCE</div>
                    </div>
                </div>
                <span>Card Force</span>
            </a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" onclick="closeMenu()">Home</a></li>
                <li><a href="shop.html" onclick="closeMenu()">Shop</a></li>
                <li><a href="marketplace.html" onclick="closeMenu()">Marketplace</a></li>
                <li><a href="help.html" onclick="closeMenu()">Help</a></li>
                <li><a href="account.html" onclick="closeMenu()">Account</a></li>
                <li><a href="#" onclick="goToCart(); closeMenu()">Cart</a></li>
            </ul>
        </div>
    </nav>
    <main class="main">
        <div class="grid">
            <div class="imgwrap">
                <div class="image-gallery">
                    <button class="gallery-arrow gallery-arrow-left" id="prevImageBtn" style="display: none;" onclick="changeImage(-1)">&#10094;</button>
                    <img id="productImage" alt="Product">
                    <button class="gallery-arrow gallery-arrow-right" id="nextImageBtn" style="display: none;" onclick="changeImage(1)">&#10095;</button>
                </div>
                <div class="image-thumbnails" id="imageThumbnails" style="display: none;"></div>
            </div>
            <div>
                <div class="title" id="productTitle">Product</div>
                <div class="price" id="productPrice"></div>
                <div class="price-extra" id="productPriceExtra"></div>
                <div class="meta" id="productStatus"></div>
                <div class="desc" id="productDesc"></div>
                <div class="actions">
                    <button class="btn buy" id="buyBtn">Buy Now</button>
                    <button class="btn cart" id="cartBtn">Add to Cart</button>
                </div>
                <div class="product-additional-info">
                    <div id="productAdditionalDescription" class="additional-description" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 10px; line-height: 1.6; display: none;">
                        <h3 style="color: #6a4c93; margin-bottom: 1rem; font-size: 1.2rem;">Product Details</h3>
                        <div id="additionalDescContent"></div>
                    </div>
                    <div id="productReturnPolicy" class="return-policy" style="margin-top: 1.5rem; padding: 1.5rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 10px; display: none;">
                        <h3 style="color: #856404; margin-bottom: 0.75rem; font-size: 1.1rem;">Return Policy</h3>
                        <div id="returnPolicyContent" style="color: #856404; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Customer Reviews Section -->
        <div class="reviews-section" style="max-width: 1200px; margin: 3rem auto; padding: 0 2rem;">
            <h2 style="color: #6a4c93; font-size: 2rem; margin-bottom: 1.5rem;">Customer Reviews</h2>
            
            <!-- Rating Summary -->
            <div id="ratingSummary" class="rating-summary" style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem;">
                <div>
                    <div id="averageRating" style="font-size: 3rem; font-weight: 800; color: #6a4c93;">0.0</div>
                    <div id="ratingStars" class="stars" style="font-size: 1.5rem; color: #ffc107; margin: 0.5rem 0;">★★★★★</div>
                    <div id="reviewCount" style="color: #666; font-size: 0.9rem;">0 reviews</div>
                </div>
            </div>
            
            <!-- Write Review Form -->
            <div id="reviewForm" class="review-form" style="background: white; border: 1px solid #ddd; border-radius: 10px; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #6a4c93; margin-bottom: 1rem;">Write a Review</h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Rating:</label>
                    <div class="star-rating" id="starRating" style="font-size: 2rem; cursor: pointer; color: #ddd;">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="reviewTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Title:</label>
                    <input type="text" id="reviewTitle" placeholder="Summary of your experience" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-family: 'Raleway', sans-serif;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="reviewText" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Review:</label>
                    <textarea id="reviewText" placeholder="Tell us about your experience with this product..." rows="5" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-family: 'Raleway', sans-serif; resize: vertical;"></textarea>
                </div>
                <button onclick="submitReview()" class="btn buy" style="border: none; padding: 0.8rem 1.5rem; border-radius: 25px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #6a4c93, #8e44ad); color: white;">Submit Review</button>
            </div>
            
            <!-- Reviews List -->
            <div id="reviewsList" class="reviews-list"></div>
        </div>
    </main>
    <footer class="footer">© 2017 Card Force. All rights reserved.</footer>

    <script>
        function qs(name) { return new URLSearchParams(location.search).get(name); }
        const id = qs('id');
        const img = document.getElementById('productImage');
        const titleEl = document.getElementById('productTitle');
        const priceEl = document.getElementById('productPrice');
        const priceExtra = document.getElementById('productPriceExtra');
        const statusEl = document.getElementById('productStatus');
        const descEl = document.getElementById('productDesc');
        const stockEl = document.getElementById('productStock');
        const buyBtn = document.getElementById('buyBtn');
        const cartBtn = document.getElementById('cartBtn');

        // Gallery state
        let currentImageIndex = 0;
        let productImages = [];

        function setImage(index) {
            if (!productImages || productImages.length === 0) return;
            
            currentImageIndex = index;
            img.src = productImages[index];
            
            // Update thumbnail active state
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }

        function changeImage(direction) {
            if (!productImages || productImages.length === 0) return;
            
            currentImageIndex += direction;
            
            // Loop around
            if (currentImageIndex < 0) {
                currentImageIndex = productImages.length - 1;
            } else if (currentImageIndex >= productImages.length) {
                currentImageIndex = 0;
            }
            
            setImage(currentImageIndex);
        }

        function loadProduct() {
            if (!id) { titleEl.textContent = 'Product not found'; return; }
            
            // Fallback if admin-utils functions aren't available
            if (typeof getProductCatalog !== 'function') {
                console.warn('Admin-utils functions not loaded, using fallback');
                const fallbackProduct = {
                    'pig-princess': { name:'Pig-princess', imageUrl:'PigPrincess.png', description:'Royal pig character with high defense.', price:7.99 },
                    'mike': { name:'Mike', imageUrl:'mike.png', description:'Stick figure warrior with balanced stats.', price:5.99 }
                };
                const p = fallbackProduct[id] || { name: id, imageUrl: '', description: 'Product description', price: 0 };
                
                img.src = p.imageUrl || '';
                titleEl.textContent = p.name || id;
                priceEl.innerHTML = `$${p.price.toFixed(2)}`;
                priceExtra.textContent = '';
                statusEl.textContent = 'Available';
                descEl.textContent = p.description || '';
                stockEl.textContent = 'Stock: 10';
                
                buyBtn.onclick = function(){
                    const paypalUrl = `https://www.paypal.com/paypalme/SongboJin/${p.price.toFixed(2)}`;
                    window.open(paypalUrl, '_blank', 'noopener,noreferrer');
                };
                cartBtn.onclick = function(){
                    alert('Added to cart');
                };
                return;
            }
            
            const catalog = getProductCatalog();
            const builtin = {
                'pig-princess': { name:'Pig-princess', imageUrl:'PigPrincess.png', description:'Royal pig character with high defense.', price:7.99 },
                'mike': { name:'Mike', imageUrl:'mike.png', description:'Stick figure warrior with balanced stats.', price:5.99 }
            };
            const p = catalog.find(x => x.id === id) || ({ id, ...(builtin[id]||{}) });
            const basePrice = getProductPrice(id) ?? p.price ?? 0;
            const discount = getProductDiscount(id) || 0;
            const discounted = basePrice * (1 - discount/100);
            const status = getProductStatus(id);
            const stock = getStock(id);

            // Setup image gallery
            currentImageIndex = 0;
            productImages = [];
            
            if (p.imageUrl) {
                productImages.push(p.imageUrl);
            }
            if (p.additionalImages && Array.isArray(p.additionalImages)) {
                productImages = productImages.concat(p.additionalImages.filter(img => img));
            }
            
            if (productImages.length > 0) {
                img.src = productImages[0];
                
                // Show arrows if multiple images
                if (productImages.length > 1) {
                    document.getElementById('prevImageBtn').style.display = 'block';
                    document.getElementById('nextImageBtn').style.display = 'block';
                    
                    // Create thumbnails
                    const thumbnailsContainer = document.getElementById('imageThumbnails');
                    thumbnailsContainer.style.display = 'flex';
                    thumbnailsContainer.innerHTML = '';
                    
                    productImages.forEach((imgSrc, index) => {
                        const thumb = document.createElement('img');
                        thumb.src = imgSrc;
                        thumb.className = 'thumbnail' + (index === 0 ? ' active' : '');
                        thumb.onclick = () => setImage(index);
                        thumbnailsContainer.appendChild(thumb);
                    });
                }
            }
            
            titleEl.textContent = p.name || id;
            priceEl.innerHTML = `$${basePrice.toFixed(2)}` + (discount>0 ? ` <span class="discount-chip">-${discount}%</span>` : '');
            priceExtra.textContent = discount>0 ? `You pay: $${discounted.toFixed(2)}` : '';
            statusEl.textContent = status === 'Backorder' ? `Backorder - Ships in ${(getProductData()[id]?.backorderDays || 7)} days` : status;
            descEl.textContent = p.description || '';
            
            // Display additional description if available
            const additionalDescContainer = document.getElementById('productAdditionalDescription');
            const additionalDescContent = document.getElementById('additionalDescContent');
            if (p.additionalDescription && p.additionalDescription.trim()) {
                additionalDescContent.textContent = p.additionalDescription;
                additionalDescContainer.style.display = 'block';
            } else {
                additionalDescContainer.style.display = 'none';
            }
            
            // Display return policy if available
            const returnPolicyContainer = document.getElementById('productReturnPolicy');
            const returnPolicyContent = document.getElementById('returnPolicyContent');
            if (p.returnPolicy && p.returnPolicy.trim()) {
                returnPolicyContent.textContent = p.returnPolicy;
                returnPolicyContainer.style.display = 'block';
            } else {
                returnPolicyContainer.style.display = 'none';
            }

            const disable = status==='Retired' || status==='Out of Stock' || stock===0;
            ;[buyBtn, cartBtn].forEach(b => { if (!b) return; b.classList.toggle('disabled-btn', disable); b.disabled = disable; });

            buyBtn.onclick = function(){
                if (disable) return;
                
                // Temporarily disabled for AdSense crawler access
                // if (window.isFirebaseOffline === true) {
                //     showCustomErrorPopup("Our database is unavailable. Unfortunately, many functions are unavailable at this time.");
                //     return;
                // }
                
                const paypalUrl = `https://www.paypal.com/paypalme/SongboJin/${(discount>0? discounted: basePrice).toFixed(2)}`;
                window.open(paypalUrl, '_blank', 'noopener,noreferrer');
            };
            cartBtn.onclick = function(){
                if (disable) return;
                
                // Temporarily disabled for AdSense crawler access
                // if (window.isFirebaseOffline === true) {
                //     showCustomErrorPopup("Our database is unavailable. Unfortunately, many functions are unavailable at this time.");
                //     return;
                // }
                
                const googleUser = localStorage.getItem('googleUser');
                if (!googleUser) { alert('Please sign in to add to cart.'); return; }
                const userData = JSON.parse(googleUser);
                const cartKey = `cart_${userData.sub}`;
                const cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
                cart.push({ id: Date.now(), name: p.name || id, price: (discount>0? discounted: basePrice), type:'trading-card', image: p.imageUrl || '' , cardId:id });
                localStorage.setItem(cartKey, JSON.stringify(cart));
                reduceStock(id, 1);
                loadProduct();
                alert('Added to cart');
            };
        }

        // Firebase Availability Check
        async function checkFirebaseAvailability() {
            try {
                let isAvailable = true;
                
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    isAvailable = await window.firebaseService.checkFirebaseAvailability();
                    
                    if (!isAvailable) {
                        alert("Our database is unavailable. Unfortunately, many functions are unavailable at this time.");
                    }
                } else {
                    // If Firebase service is not initialized, assume offline
                    isAvailable = false;
                }
                
                // Update database down banner
                const databaseDownBanner = document.getElementById('databaseDownBanner');
                if (databaseDownBanner) {
                    if (!isAvailable) {
                        databaseDownBanner.style.display = 'flex';
                    } else {
                        databaseDownBanner.style.display = 'none';
                    }
                }
                
            // Update global offline state
            window.isFirebaseOffline = !isAvailable;
            
            // Update button states
            updateButtonStates();
                
            } catch (error) {
                console.error('Error checking Firebase availability:', error);
                
                // Show database down banner on error
                const databaseDownBanner = document.getElementById('databaseDownBanner');
                if (databaseDownBanner) {
                    databaseDownBanner.style.display = 'flex';
                }
                window.isFirebaseOffline = true;
            
            // Update button states
            updateButtonStates();
                showCustomErrorPopup("Our database is unavailable. Unfortunately, many functions are unavailable at this time.");
            }
        }

        // Temporarily disabled for AdSense crawler access
        function showCustomErrorPopup(message) {
            // Disabled - no error messages for AdSense crawler
            return;
            /*
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Create popup content
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                text-align: center;
                position: relative;
            `;

            popup.innerHTML = `
                <div style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                <h3 style="color: #dc3545; margin-bottom: 1rem; font-size: 1.3rem;">Service Unavailable</h3>
                <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.5;">${message}</p>
                <button onclick="this.closest('.error-popup-overlay').remove()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 0.8rem 2rem;
                    border-radius: 25px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: background 0.3s ease;
                " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                    OK
                </button>
            `;

            overlay.className = 'error-popup-overlay';
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            }); */
        }

        // Temporarily disabled for AdSense crawler access
        function updateButtonStates() {
            // Disabled - buttons should always be enabled for AdSense crawler
            return;
        }

        // Temporarily disabled for AdSense crawler access
        function applyButtonHandlers() {
            // Disabled - buttons should work normally for AdSense crawler
            return;
        }

        // Temporarily disabled for AdSense crawler access
        function addDisabledButtonHandlers() {
            // Disabled - buttons should work normally for AdSense crawler
            return;
        }

        // ============================================
        // REVIEW SYSTEM
        // ============================================
        
        let selectedRating = 0;
        
        // Star rating hover and click
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star');
            
            stars.forEach(star => {
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(rating);
                });
                
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(selectedRating);
                });
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', function() {
                highlightStars(selectedRating);
            });
        });
        
        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ddd';
                }
            });
        }
        
        function submitReview() {
            const googleUser = localStorage.getItem('googleUser');
            if (!googleUser) {
                alert('Please sign in to write a review');
                return;
            }
            
            if (selectedRating === 0) {
                alert('Please select a rating');
                return;
            }
            
            const title = document.getElementById('reviewTitle').value.trim();
            const text = document.getElementById('reviewText').value.trim();
            
            if (!title || !text) {
                alert('Please fill in all fields');
                return;
            }
            
            const userData = JSON.parse(googleUser);
            
            const review = {
                rating: selectedRating,
                title: title,
                text: text,
                userName: userData.name || userData.email,
                userEmail: userData.email
            };
            
            // Add review using admin-utils function
            const addReviewFunc = typeof addProductReview === 'function' ? addProductReview : 
                                 (typeof window.addProductReview === 'function' ? window.addProductReview : null);
            
            if (addReviewFunc) {
                const savedReview = addReviewFunc(id, review);
                
                // Save to Firebase
                saveReviewToFirebaseActual(savedReview);
                
                // Clear form
                selectedRating = 0;
                document.getElementById('reviewTitle').value = '';
                document.getElementById('reviewText').value = '';
                highlightStars(0);
                
                // Reload reviews
                loadReviews();
                
                alert('Thank you for your review!');
            } else {
                console.error('Review functions not available - waiting for admin-utils.js to load');
                // Retry after a delay
                setTimeout(() => {
                    submitReview();
                }, 1000);
            }
        }
        
        async function loadReviews() {
            console.log('loadReviews called');
            console.log('adminUtilsLoaded?', window.adminUtilsLoaded);
            console.log('getProductReviews available?', typeof getProductReviews);
            console.log('window.getProductReviews available?', typeof window.getProductReviews);
            
            // Check if admin-utils.js has loaded
            if (!window.adminUtilsLoaded) {
                console.warn('admin-utils.js not loaded yet, waiting...');
                const reviewsList = document.getElementById('reviewsList');
                if (reviewsList) {
                    reviewsList.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">Loading reviews...</p>';
                }
                setTimeout(() => {
                    loadReviews();
                }, 500);
                return;
            }
            
            // Check both global and window scope
            const reviewFunc = typeof getProductReviews === 'function' ? getProductReviews : 
                               (typeof window.getProductReviews === 'function' ? window.getProductReviews : null);
            
            if (!reviewFunc) {
                console.error('Review functions not available even though admin-utils.js loaded!');
                console.log('Window keys with "Review":', Object.keys(window).filter(k => k.toLowerCase().includes('review')));
                console.log('Window keys with "Product":', Object.keys(window).filter(k => k.toLowerCase().includes('product')));
                
                // Show error message
                const reviewsList = document.getElementById('reviewsList');
                if (reviewsList) {
                    reviewsList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Reviews temporarily unavailable. Please refresh the page.</p>';
                }
                return;
            }
            
            console.log('✅ Review functions available, loading reviews');
            
            // Load from Firebase first if available
            try {
                await loadReviewsFromFirebaseActual(id);
            } catch (error) {
                console.error('Error loading reviews from Firebase:', error);
            }
            
            renderReviews();
        }
        
        // Actual Firebase implementation
        async function loadReviewsFromFirebaseActual(productId) {
            if (!window.db || !window.collection || !window.query || !window.where || !window.getDocs) {
                console.log('Firebase not available for loading reviews');
                return;
            }
            
            try {
                const reviewsRef = window.collection(window.db, 'reviews');
                const q = window.query(reviewsRef, window.where('productId', '==', productId));
                const querySnapshot = await window.getDocs(q);
                
                const reviews = [];
                querySnapshot.forEach((docSnap) => {
                    reviews.push(docSnap.data());
                });
                
                // Save to localStorage
                const reviewsKey = `reviews_${productId}`;
                localStorage.setItem(reviewsKey, JSON.stringify(reviews));
                
                console.log(`✅ Loaded ${reviews.length} reviews from Firebase for ${productId}`);
                return reviews;
            } catch (error) {
                console.error('❌ Error loading reviews from Firebase:', error);
                return [];
            }
        }
        
        // Save review to Firebase
        async function saveReviewToFirebaseActual(review) {
            if (!window.db || !window.doc || !window.setDoc) {
                console.log('Firebase not available for review sync');
                return;
            }
            
            try {
                const reviewRef = window.doc(window.db, 'reviews', review.id.toString());
                await window.setDoc(reviewRef, review);
                console.log('✅ Review saved to Firebase');
            } catch (error) {
                console.error('❌ Error saving review to Firebase:', error);
            }
        }
        
        // Delete review from Firebase
        async function deleteReviewFromFirebaseActual(reviewId) {
            if (!window.db || !window.doc || !window.deleteDoc) {
                console.log('Firebase not available for review deletion');
                return;
            }
            
            try {
                const reviewRef = window.doc(window.db, 'reviews', reviewId.toString());
                await window.deleteDoc(reviewRef);
                console.log('✅ Review deleted from Firebase');
            } catch (error) {
                console.error('❌ Error deleting review from Firebase:', error);
            }
        }
        
        function renderReviews() {
            // Check both global and window scope
            const getReviewsFunc = typeof getProductReviews === 'function' ? getProductReviews : 
                                   (typeof window.getProductReviews === 'function' ? window.getProductReviews : null);
            const getAvgFunc = typeof getAverageRating === 'function' ? getAverageRating : 
                              (typeof window.getAverageRating === 'function' ? window.getAverageRating : null);
            
            if (!getReviewsFunc || !getAvgFunc) {
                console.error('Review functions not available in renderReviews');
                return;
            }
            
            const reviews = getReviewsFunc(id);
            const reviewsList = document.getElementById('reviewsList');
            const averageRatingEl = document.getElementById('averageRating');
            const ratingStarsEl = document.getElementById('ratingStars');
            const reviewCountEl = document.getElementById('reviewCount');
            
            // Update summary
            const avgRating = getAvgFunc(id);
            averageRatingEl.textContent = avgRating;
            reviewCountEl.textContent = `${reviews.length} review${reviews.length !== 1 ? 's' : ''}`;
            
            // Update stars display
            const fullStars = Math.floor(avgRating);
            const hasHalfStar = avgRating % 1 >= 0.5;
            let starsHTML = '';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHTML += '★';
                } else if (i === fullStars && hasHalfStar) {
                    starsHTML += '☆';
                } else {
                    starsHTML += '☆';
                }
            }
            ratingStarsEl.innerHTML = starsHTML;
            
            // Render reviews
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No reviews yet. Be the first to review this product!</p>';
                return;
            }
            
            // Sort reviews by timestamp (newest first)
            reviews.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            reviewsList.innerHTML = reviews.map(review => {
                const date = new Date(review.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                
                const deleteBtn = (typeof isAdmin === 'function' && isAdmin()) ? 
                    `<button onclick="deleteReview('${review.id}')" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-left: 1rem;">Delete</button>` : '';
                
                return `
                    <div class="review-item" style="background: white; border: 1px solid #ddd; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <div style="color: #ffc107; font-size: 1.2rem; margin-bottom: 0.25rem;">${stars}</div>
                                <div style="font-weight: 700; color: #333; font-size: 1.1rem;">${review.title}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #666; font-size: 0.85rem;">${review.userName}</div>
                                <div style="color: #999; font-size: 0.75rem;">${date}</div>
                            </div>
                        </div>
                        <div style="color: #555; line-height: 1.6; margin-top: 1rem;">${review.text}</div>
                        ${deleteBtn}
                    </div>
                `;
            }).join('');
        }
        
        function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) {
                return;
            }
            
            const deleteFunc = typeof deleteProductReview === 'function' ? deleteProductReview : 
                              (typeof window.deleteProductReview === 'function' ? window.deleteProductReview : null);
            
            if (deleteFunc) {
                deleteFunc(id, parseInt(reviewId));
                
                // Delete from Firebase
                deleteReviewFromFirebaseActual(parseInt(reviewId));
                
                loadReviews();
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load product immediately
            loadProduct();
            
            // Wait for admin-utils to load for reviews and nav
            setTimeout(() => {
                if (typeof addGlobalNavElements === 'function') {
                    addGlobalNavElements();
                }
                
                // Load reviews with retry mechanism
                loadReviews();
                
            // Temporarily removed for AdSense crawler access
            // setTimeout(() => {
            //     checkFirebaseAvailability();
            //     addDisabledButtonHandlers();
            // }, 2000);
            }, 800);
        });

        // Hamburger menu functions
        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');
            
            navMenu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function closeMenu() {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');
            
            navMenu.classList.remove('active');
            hamburger.classList.remove('active');
        }

        function goToCart() {
            const googleUser = localStorage.getItem('googleUser');
            if (!googleUser) {
                alert('Please sign in to access your cart! 🛒');
                window.location.href = 'account.html';
                return;
            }
            window.location.href = 'cart.html';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');
            const navbar = document.querySelector('.navbar');
            
            if (!navbar.contains(event.target) && navMenu.classList.contains('active')) {
                closeMenu();
            }
        });

        // Close menu on window resize if screen becomes larger
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMenu();
            }
        });
    </script>
</body>
</html>

