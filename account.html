<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9986380390919018">
    <title>Account - Card Force</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9986380390919018"
     crossorigin="anonymous"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="admin-utils.js"></script>
    <!-- Firebase CDN -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, signInWithPopup, GoogleAuthProvider, signOut as firebaseSignOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCJNv4DDv8Gbvtw3zRzsvNk3xW3e2sog7k",
        authDomain: "card-force-472100.firebaseapp.com",
        projectId: "card-force-472100",
        storageBucket: "card-force-472100.firebasestorage.app",
        messagingSenderId: "91438507562",
        appId: "1:91438507562:web:85673cf7f40190f4310553",
        measurementId: "G-J2Q14Y5FXS"
      };
      
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      
      // Make available globally
      window.db = db;
      window.auth = auth;
      window.GoogleAuthProvider = GoogleAuthProvider;
      window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.updateProfile = updateProfile;
      window.firebaseSignOut = firebaseSignOut;
    </script>
    <!-- Firebase Service -->
    <script type="module" src="firebase-config.js"></script>
    <script>
      // Load product data from Firebase after initialization
      setTimeout(async () => {
        console.log('🔄 Account Page: Attempting to load product data from Firebase...');
        
        // Ensure Firebase service is initialized
        const googleUser = localStorage.getItem('googleUser');
        if (googleUser && !window.firebaseService?.currentUser) {
          console.log('🔄 Account Page: Initializing Firebase service with Google user...');
          const userData = JSON.parse(googleUser);
          window.firebaseService.currentUser = {
            uid: userData.sub,
            email: userData.email,
            displayName: userData.name,
            photoURL: userData.picture
          };
          window.firebaseService.isInitialized = true;
        }
        
        if (window.loadProductDataFromFirebase) {
          await window.loadProductDataFromFirebase();
        }
        
        // Set up real-time listener for product changes
        if (window.setupProductDataListener) {
          window.setupProductDataListener();
        }
      }, 2000);
      
      // Listen for product data updates
      window.addEventListener('productDataUpdated', () => {
        console.log('📡 Account: Product data updated, refreshing display...');
        // Refresh any product-related displays on the account page
        if (typeof refreshProductDisplay === 'function') {
          refreshProductDisplay();
        }
      });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Raleway', sans-serif;
            background-color: white;
            color: #333;
            line-height: 1.6;
        }

        /* Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #6a4c93, #8e44ad);
            padding: 0.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 2px 20px rgba(106, 76, 147, 0.3); }
            100% { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.25rem;
            position: relative;
        }

        .logo {
            color: white;
            font-size: 1.4rem;
            font-weight: bold;
            text-decoration: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: bounce 1s infinite alternate;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-3px); }
        }

        .logo-icon {
            width: 40px;
            height: 48px;
            background: #2c2c2c;
            border: 3px solid #1a1a1a;
            border-radius: 8px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 15px 15px 0;
            border-color: transparent #1a1a1a transparent transparent;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 12px 12px 0;
            border-color: transparent #2c2c2c transparent transparent;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 800;
            line-height: 0.8;
            letter-spacing: 0.5px;
        }

        .logo-divider {
            width: 30px;
            height: 2px;
            background: #1a1a1a;
            margin: 2px 0;
        }

        .offline-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            border: 2px solid white;
            display: none;
            z-index: 10;
        }

        .offline-indicator::after {
            content: "⚠";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: white;
            font-weight: bold;
        }

        .database-down-banner {
            background: #ffc107;
            color: #212529;
            padding: 12px 20px;
            margin: 0;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid #e0a800;
            position: relative;
            z-index: 100;
        }
        .database-down-text {
            text-align: center;
            line-height: 1.4;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 1rem;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 0.35rem 0.75rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-menu a:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(106, 76, 147, 0.4);
        }

        .nav-menu a.active {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(106, 76, 147, 0.4);
            font-weight: 600;
        }


        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .account-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
            margin: 2rem 0;
        }

        .account-container {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(106, 76, 147, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .account-container:hover {
            border-color: #6a4c93;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(106, 76, 147, 0.2);
            animation: none;
        }

        .account-title {
            font-size: 2.5rem;
            color: #6a4c93;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.1), 0 0 10px rgba(106, 76, 147, 0.5); }
            to { text-shadow: 2px 2px 4px rgba(0,0,0,0.1), 0 0 20px rgba(106, 76, 147, 0.8); }
        }

        .account-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .auth-container {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .google-signin-container {
            display: flex;
            justify-content: center;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            color: #666;
            font-size: 0.9rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
            margin: 0 1rem;
        }

        .email-auth-form {
            width: 100%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-top: 1rem;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .auth-container.hidden {
            display: none;
        }

        .account-subtitle.hidden {
            display: none;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #6a4c93;
            box-shadow: 0 0 0 3px rgba(106, 76, 147, 0.1);
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }

        .auth-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .auth-btn-primary {
            background: #6a4c93;
            color: white;
        }

        .auth-btn-primary:hover {
            background: #5a3d83;
            transform: translateY(-1px);
        }

        .auth-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .auth-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .auth-btn-outline {
            background: transparent;
            color: #6a4c93;
            border: 2px solid #6a4c93;
        }

        .auth-btn-outline:hover {
            background: #6a4c93;
            color: white;
        }

        .auth-toggle {
            background: none;
            border: none;
            color: #6a4c93;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-top: 0.5rem;
        }

        .auth-toggle:hover {
            color: #5a3d83;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin: 0.5rem 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin: 0.5rem 0;
            border: 1px solid #c3e6cb;
        }

        .google-signin-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            animation: pulse-btn 2s infinite;
        }

        @keyframes pulse-btn {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .google-signin-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
            animation: none;
        }

        .google-icon {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #4285f4;
        }

        .user-info {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border: 2px solid #6a4c93;
        }

        .user-info.show {
            display: block;
            animation: slide-in 0.5s ease-out;
        }

        @keyframes slide-in {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            border: 3px solid #6a4c93;
        }


        .user-name {
            font-size: 1.5rem;
            color: #6a4c93;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .user-email {
            color: #666;
            margin-bottom: 1rem;
        }

        .signout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .signout-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .user-actions {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        .account-btn {
            background: linear-gradient(135deg, #6a4c93, #8e44ad);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .account-btn:hover {
            background: linear-gradient(135deg, #5a3c83, #7e349d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 76, 147, 0.3);
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #6a4c93, #8e44ad);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: skewY(0deg); }
            50% { transform: skewY(1deg); }
        }

        /* Custom Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            color: #6a4c93;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .modal p {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: #6a4c93;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #5a3d83;
            transform: translateY(-2px);
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .logo {
                font-size: 1.4rem;
            }

            .logo-icon {
                width: 40px;
                height: 50px;
            }

            .logo-text {
                font-size: 0.6rem;
            }

            .logo-divider {
                width: 25px;
            }

            .account-container {
                padding: 2rem;
                margin: 1rem;
            }

            .account-title {
                font-size: 2rem;
            }

            .google-signin-btn {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Database Down Banner -->
    <div id="databaseDownBanner" class="database-down-banner" style="display: none;">
        <div class="database-down-text">
            Database is down, many services are unavailable
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <div class="logo-text">
                        <div>CARD</div>
                        <div class="logo-divider"></div>
                        <div>FORCE</div>
                    </div>
                </div>
                <span>Card Force</span>
                <div class="offline-indicator" id="offlineIndicator"></div>
            </a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" onclick="closeMenu()">Home</a></li>
                <li><a href="shop.html" onclick="closeMenu()">Shop</a></li>
                <li><a href="marketplace.html" onclick="closeMenu()">Marketplace</a></li>
                <li><a href="about.html" onclick="closeMenu()">About</a></li>
                <li><a href="help.html" onclick="closeMenu()">Help</a></li>
                <li><a href="account.html" class="active" onclick="closeMenu()">Account</a></li>
                <li><a href="#" onclick="goToCart(); closeMenu()">Cart</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <section class="account-section">
            <div class="account-container">
                <h1 class="account-title">Account</h1>
                <p class="account-subtitle">Sign in to save your custom cards and access exclusive features</p>
                
                <div class="auth-container">
                    <!-- Google Sign-In -->
                    <div class="google-signin-container">
                        <div id="g_id_onload"
                             data-client_id="91438507562-jue5hjq2i6lskjgd1vhbe03ql2kkjp0k.apps.googleusercontent.com"
                             data-callback="handleCredentialResponse"
                             data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-size="large"
                             data-theme="outline"
                             data-text="sign_in_with"
                             data-shape="rectangular"
                             data-logo_alignment="left">
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="auth-divider">or</div>

                    <!-- Email/Password Forms -->
                    <div class="email-auth-form">
                        <!-- Sign In Form -->
                        <div id="signInForm">
                            <h3 style="text-align: center; margin-bottom: 1rem; color: #6a4c93;">Sign In</h3>
                            <div class="form-group">
                                <label for="signInEmail">Email</label>
                                <input type="email" id="signInEmail" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label for="signInPassword">Password</label>
                                <input type="password" id="signInPassword" placeholder="Enter your password" required>
                            </div>
                            <div class="auth-buttons">
                                <button class="auth-btn auth-btn-primary" onclick="signInWithEmail()">Sign In</button>
                                <button class="auth-toggle" onclick="showSignUpForm()">Don't have an account? Sign up</button>
                                <button class="auth-toggle" onclick="showForgotPasswordModal()" style="color: #6a4c93; font-size: 0.9rem; margin-top: 0.5rem;">Forgot Password?</button>
                            </div>
                        </div>

                        <!-- Sign Up Form -->
                        <div id="signUpForm" style="display: none;">
                            <h3 style="text-align: center; margin-bottom: 1rem; color: #6a4c93;">Create Account</h3>
                            <div class="form-group">
                                <label for="signUpName">Full Name</label>
                                <input type="text" id="signUpName" placeholder="Enter your full name" required>
                            </div>
                            <div class="form-group">
                                <label for="signUpEmail">Email</label>
                                <input type="email" id="signUpEmail" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label for="signUpPassword">Password</label>
                                <input type="password" id="signUpPassword" placeholder="Create a password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                            </div>
                            
                            <!-- Security Questions Section -->
                            <div class="security-questions-section" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                <h4 style="margin: 0 0 1rem 0; color: #6a4c93; font-size: 1.1rem;">Security Questions</h4>
                                <p style="margin: 0 0 1rem 0; color: #666; font-size: 0.9rem;">These will be used for password recovery</p>
                                
                                <div class="form-group">
                                    <label for="securityQuestion1">What month were you born?</label>
                                    <select id="securityQuestion1" required>
                                        <option value="">Select month</option>
                                        <option value="January">January</option>
                                        <option value="February">February</option>
                                        <option value="March">March</option>
                                        <option value="April">April</option>
                                        <option value="May">May</option>
                                        <option value="June">June</option>
                                        <option value="July">July</option>
                                        <option value="August">August</option>
                                        <option value="September">September</option>
                                        <option value="October">October</option>
                                        <option value="November">November</option>
                                        <option value="December">December</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="securityQuestion2">What is your favorite color?</label>
                                    <select id="securityQuestion2" required>
                                        <option value="">Select color</option>
                                        <option value="Red">Red</option>
                                        <option value="Blue">Blue</option>
                                        <option value="Green">Green</option>
                                        <option value="Yellow">Yellow</option>
                                        <option value="Purple">Purple</option>
                                        <option value="Orange">Orange</option>
                                        <option value="Pink">Pink</option>
                                        <option value="Black">Black</option>
                                        <option value="White">White</option>
                                        <option value="Gray">Gray</option>
                                        <option value="Brown">Brown</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="securityQuestion3">What best describes your personality?</label>
                                    <select id="securityQuestion3" required>
                                        <option value="">Select option</option>
                                        <option value="Adventurous">Adventurous</option>
                                        <option value="Creative">Creative</option>
                                        <option value="Analytical">Analytical</option>
                                        <option value="Compassionate">Compassionate</option>
                                        <option value="Independent">Independent</option>
                                        <option value="Organized">Organized</option>
                                        <option value="Spontaneous">Spontaneous</option>
                                        <option value="Optimistic">Optimistic</option>
                                        <option value="Practical">Practical</option>
                                        <option value="Introverted">Introverted</option>
                                        <option value="Extroverted">Extroverted</option>
                                    </select>
                                </div>
                            </div>
                            <div class="auth-buttons">
                                <button class="auth-btn auth-btn-primary" onclick="createAccountWithEmail()">Create Account</button>
                                <button class="auth-toggle" onclick="showSignInForm()">Already have an account? Sign in</button>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="authMessage"></div>
                    </div>
                </div>

                <!-- Forgot Password Modal -->
                <div id="forgotPasswordModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 500px;">
                        <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
                        <h2 style="text-align: center; margin-bottom: 1.5rem; color: #6a4c93;">Forgot Password</h2>
                        
                        <div id="forgotPasswordStep1">
                            <div class="form-group">
                                <label for="forgotEmail">Enter your email address</label>
                                <input type="email" id="forgotEmail" placeholder="Enter your email" required>
                            </div>
                            <div class="auth-buttons">
                                <button class="auth-btn auth-btn-primary" onclick="checkSecurityQuestions()">Continue</button>
                                <button class="auth-toggle" onclick="closeForgotPasswordModal()">Cancel</button>
                            </div>
                        </div>
                        
                        <div id="forgotPasswordStep2" style="display: none;">
                            <h3 style="text-align: center; margin-bottom: 1rem; color: #6a4c93;">Answer Security Questions</h3>
                            <div class="form-group">
                                <label id="securityQuestionLabel1">Question 1</label>
                                <select id="forgotSecurityAnswer1" required>
                                    <option value="">Select answer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="securityQuestionLabel2">Question 2</label>
                                <select id="forgotSecurityAnswer2" required>
                                    <option value="">Select answer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="securityQuestionLabel3">Question 3</label>
                                <select id="forgotSecurityAnswer3" required>
                                    <option value="">Select answer</option>
                                </select>
                            </div>
                            <div class="auth-buttons">
                                <button class="auth-btn auth-btn-primary" onclick="verifySecurityAnswers()">Verify</button>
                                <button class="auth-toggle" onclick="closeForgotPasswordModal()">Cancel</button>
                            </div>
                        </div>
                        
                        <div id="forgotPasswordStep3" style="display: none;">
                            <h3 style="text-align: center; margin-bottom: 1rem; color: #6a4c93;">Reset Password</h3>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirmNewPassword">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" placeholder="Confirm new password" required>
                            </div>
                            <div class="auth-buttons">
                                <button class="auth-btn auth-btn-primary" onclick="resetPassword()">Reset Password</button>
                                <button class="auth-toggle" onclick="closeForgotPasswordModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Security Questions Modal -->
                <div id="changeSecurityQuestionsModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <button class="modal-close" onclick="closeChangeSecurityQuestionsModal()">&times;</button>
                        <h2 style="text-align: center; margin-bottom: 1.5rem; color: #6a4c93;">Change Security Questions</h2>
                        
                        <div class="form-group">
                            <label for="currentPasswordForSecurity">Current Password</label>
                            <input type="password" id="currentPasswordForSecurity" placeholder="Enter current password" required>
                        </div>
                        
                        <div class="security-questions-section" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h4 style="margin: 0 0 1rem 0; color: #6a4c93; font-size: 1.1rem;">New Security Questions</h4>
                            
                            <div class="form-group">
                                <label for="newSecurityQuestion1">What month were you born?</label>
                                <select id="newSecurityQuestion1" required>
                                    <option value="">Select month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="newSecurityQuestion2">What is your favorite color?</label>
                                <select id="newSecurityQuestion2" required>
                                    <option value="">Select color</option>
                                    <option value="Red">Red</option>
                                    <option value="Blue">Blue</option>
                                    <option value="Green">Green</option>
                                    <option value="Yellow">Yellow</option>
                                    <option value="Purple">Purple</option>
                                    <option value="Orange">Orange</option>
                                    <option value="Pink">Pink</option>
                                    <option value="Black">Black</option>
                                    <option value="White">White</option>
                                    <option value="Gray">Gray</option>
                                    <option value="Brown">Brown</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="newSecurityQuestion3">What best describes your personality?</label>
                                <select id="newSecurityQuestion3" required>
                                    <option value="">Select option</option>
                                    <option value="Adventurous">Adventurous</option>
                                    <option value="Creative">Creative</option>
                                    <option value="Analytical">Analytical</option>
                                    <option value="Compassionate">Compassionate</option>
                                    <option value="Independent">Independent</option>
                                    <option value="Organized">Organized</option>
                                    <option value="Spontaneous">Spontaneous</option>
                                    <option value="Optimistic">Optimistic</option>
                                    <option value="Practical">Practical</option>
                                    <option value="Introverted">Introverted</option>
                                    <option value="Extroverted">Extroverted</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="auth-buttons">
                            <button class="auth-btn auth-btn-primary" onclick="updateSecurityQuestions()">Update Security Questions</button>
                            <button class="auth-toggle" onclick="closeChangeSecurityQuestionsModal()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div class="user-info" id="userInfo">
                    <img class="user-avatar" id="userAvatar" src="" alt="User Avatar">
                    <div class="user-name" id="userName"></div>
                    <div class="user-email" id="userEmail"></div>
                    <div class="user-actions">
                        <button class="account-btn" onclick="goToSavedDesigns()">Saved Designs</button>
                        <button class="account-btn" onclick="showOrdersModal()">My Orders</button>
                        <button class="account-btn" onclick="showAddressManager()">Manage Addresses</button>
                        <button class="account-btn" id="changeSecurityQuestionsBtn" onclick="showChangeSecurityQuestionsModal()" style="display: none;">Change Security Questions</button>
                        
                        <!-- Admin Controls -->
                        <div id="adminControls" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e9ecef;">
                            <h3 style="color: #6a4c93; margin-bottom: 1rem;">Admin Controls</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="account-btn" id="freezeBtn" onclick="toggleSiteFreeze()" style="background: #dc3545; border-color: #dc3545;">Freeze Site</button>
                                <button class="account-btn" id="unfreezeBtn" onclick="toggleSiteFreeze()" style="background: #28a745; border-color: #28a745; display: none;">Unfreeze Site</button>
                            </div>
                        </div>
                    </div>
                    <button class="signout-btn" onclick="signOut()">Sign Out</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Card Force. All rights reserved. | The Ultimate Card Game Experience</p>
    </footer>

    <script>
        // Email/Password Authentication Functions
        function showSignUpForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'block';
            clearAuthMessage();
        }

        function showSignInForm() {
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('signInForm').style.display = 'block';
            clearAuthMessage();
        }

        function clearAuthMessage() {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.innerHTML = '';
            messageDiv.className = '';
        }

        function showAuthMessage(message, type = 'error') {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.innerHTML = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        }

        async function signInWithEmail() {
            // Check if Firebase is offline
            if (window.isFirebaseOffline === true) {
                showFirebaseErrorMessage();
                return;
            }
            
            console.log('🔍 Sign-in button clicked');
            console.log('🔍 Firebase functions available:', {
                auth: !!window.auth,
                signInWithEmailAndPassword: !!window.signInWithEmailAndPassword,
                createUserWithEmailAndPassword: !!window.createUserWithEmailAndPassword
            });

            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;

            console.log('🔍 Form values:', { email, password: password ? '***' : 'empty' });

            if (!email || !password) {
                showAuthMessage('Please fill in all fields');
                return;
            }

            if (!window.signInWithEmailAndPassword || !window.auth) {
                showAuthMessage('Firebase authentication not ready. Please refresh the page.');
                return;
            }

            try {
                console.log('🔍 Attempting Firebase sign-in...');
                const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;
                
                // Store user data similar to Google Sign-In
                const userData = {
                    sub: user.uid,
                    email: user.email,
                    name: user.displayName || user.email.split('@')[0],
                    picture: user.photoURL || 'https://via.placeholder.com/150/6a4c93/ffffff?text=' + (user.displayName || user.email).charAt(0).toUpperCase(),
                    authType: 'email' // Mark as email account
                };
                
                // Try to load security questions from Firebase/localStorage
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    try {
                        const securityQuestions = await window.firebaseService.getSecurityQuestions(user.email);
                        if (securityQuestions) {
                            userData.securityQuestions = securityQuestions;
                        }
                    } catch (error) {
                        console.error('Error loading security questions during sign-in:', error);
                    }
                }
                
                localStorage.setItem('googleUser', JSON.stringify(userData));
                displayUserInfo(userData);
                showAuthMessage('Successfully signed in!', 'success');
                
                console.log('Email sign-in successful:', user);
            } catch (error) {
                console.error('Email sign-in error:', error);
                let errorMessage = 'Sign-in failed. ';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage += 'This account has been disabled.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAuthMessage(errorMessage);
            }
        }

        async function createAccountWithEmail() {
            // Check if Firebase is offline
            if (window.isFirebaseOffline === true) {
                showFirebaseErrorMessage();
                return;
            }
            
            // Check if site is frozen
            if (await isSiteFrozen()) {
                showSiteFrozenMessage();
                return;
            }
            
            console.log('🔍 Create account button clicked');
            console.log('🔍 Firebase functions available:', {
                auth: !!window.auth,
                createUserWithEmailAndPassword: !!window.createUserWithEmailAndPassword,
                updateProfile: !!window.updateProfile
            });

            const name = document.getElementById('signUpName').value;
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Get security question answers
            const securityQuestion1 = document.getElementById('securityQuestion1').value;
            const securityQuestion2 = document.getElementById('securityQuestion2').value;
            const securityQuestion3 = document.getElementById('securityQuestion3').value;

            console.log('🔍 Form values:', { name, email, password: password ? '***' : 'empty', confirmPassword: confirmPassword ? '***' : 'empty' });

            if (!name || !email || !password || !confirmPassword) {
                showAuthMessage('Please fill in all fields');
                return;
            }
            
            if (!securityQuestion1 || !securityQuestion2 || !securityQuestion3) {
                showAuthMessage('Please answer all security questions');
                return;
            }

            if (password !== confirmPassword) {
                showAuthMessage('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters long');
                return;
            }

            if (!window.createUserWithEmailAndPassword || !window.auth) {
                showAuthMessage('Firebase authentication not ready. Please refresh the page.');
                return;
            }

            try {
                console.log('🔍 Attempting Firebase account creation...');
                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;
                
                // Update the user's display name
                await window.updateProfile(user, {
                    displayName: name
                });
                
                // Store user data similar to Google Sign-In
                const userData = {
                    sub: user.uid,
                    email: user.email,
                    name: name,
                    picture: 'https://via.placeholder.com/150/6a4c93/ffffff?text=' + name.charAt(0).toUpperCase(),
                    authType: 'email', // Mark as email account
                    securityQuestions: {
                        question1: 'What month were you born?',
                        answer1: securityQuestion1,
                        question2: 'What is your favorite color?',
                        answer2: securityQuestion2,
                        question3: 'What best describes your personality?',
                        answer3: securityQuestion3
                    }
                };
                
                localStorage.setItem('googleUser', JSON.stringify(userData));
                
                // Also store security questions in Firebase for password recovery
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    try {
                        const securityQuestionsWithEmail = {
                            ...userData.securityQuestions,
                            email: user.email
                        };
                        await window.firebaseService.saveSecurityQuestions(user.uid, securityQuestionsWithEmail);
                        console.log('✅ Security questions saved to Firebase');
                    } catch (error) {
                        console.error('❌ Failed to save security questions to Firebase:', error);
                    }
                }
                displayUserInfo(userData);
                showAuthMessage('Account created successfully!', 'success');
                
                // Switch back to sign-in form
                setTimeout(() => {
                    showSignInForm();
                    // Clear the form
                    document.getElementById('signUpName').value = '';
                    document.getElementById('signUpEmail').value = '';
                    document.getElementById('signUpPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('securityQuestion1').value = '';
                    document.getElementById('securityQuestion2').value = '';
                    document.getElementById('securityQuestion3').value = '';
                }, 2000);
                
                console.log('Account creation successful:', user);
            } catch (error) {
                console.error('Account creation error:', error);
                let errorMessage = 'Account creation failed. ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'An account with this email already exists.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password is too weak.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAuthMessage(errorMessage);
            }
        }

        // Disable/enable buttons based on Firebase status
        function updateButtonStates() {
            const isOffline = window.isFirebaseOffline === true;
            const authButtons = document.querySelectorAll('.auth-btn, .sign-in-btn, .create-account-btn, .forgot-password-btn, .change-security-btn');
            
            // Update authentication buttons
            authButtons.forEach(button => {
                if (isOffline) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                    button.title = 'Service unavailable - Database is down';
                } else {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.title = '';
                }
            });
            
            // Apply handlers to all buttons
            applyButtonHandlers();
        }

        // Apply button handlers for disabled buttons
        function applyButtonHandlers() {
            // Override button onclick handlers directly
            const authButtons = document.querySelectorAll('.auth-btn, .sign-in-btn, .create-account-btn, .forgot-password-btn, .change-security-btn');
            
            authButtons.forEach(button => {
                const originalOnclick = button.getAttribute('onclick');
                if (originalOnclick && !originalOnclick.includes('window.isFirebaseOffline')) {
                    button.setAttribute('onclick', `
                        if (window.isFirebaseOffline === true) {
                            showCustomErrorPopup("Our database is unavailable. Unfortunately, many functions are unavailable at this time.");
                            return false;
                        }
                        ${originalOnclick}
                    `);
                }
            });
        }

        // Add click handlers for disabled buttons
        function addDisabledButtonHandlers() {
            applyButtonHandlers();
        }

        // Google Sign-In Configuration
        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "91438507562-jue5hjq2i6lskjgd1vhbe03ql2kkjp0k.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });

            // Check if user is already signed in
            checkExistingSignIn();
            
            // Check Firebase availability
            setTimeout(() => {
                checkFirebaseAvailability();
                addDisabledButtonHandlers();
            }, 2000);
        };

        function checkExistingSignIn() {
            const savedUser = localStorage.getItem('googleUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    displayUserInfo(userData);
                } catch (e) {
                    console.error('Error parsing saved user data:', e);
                    localStorage.removeItem('googleUser');
                }
            }
        }

        function displayUserInfo(userData) {
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userEmail').textContent = userData.email;
            document.getElementById('userAvatar').src = userData.picture;
            document.getElementById('userInfo').classList.add('show');
            
            // Show/hide security questions button based on account type
            const securityBtn = document.getElementById('changeSecurityQuestionsBtn');
            if (userData.authType === 'email') {
                securityBtn.style.display = 'block';
            } else {
                securityBtn.style.display = 'none';
            }
            
            // Show/hide admin controls based on admin status
            const adminControls = document.getElementById('adminControls');
            if (typeof isAdmin === 'function' && isAdmin()) {
                adminControls.style.display = 'block';
                updateFreezeButtonStates();
            } else {
                adminControls.style.display = 'none';
            }
            
            // Hide the sign-in forms and subtitle
            document.querySelector('.g_id_signin').style.display = 'none';
            document.querySelector('.auth-container').classList.add('hidden');
            document.querySelector('.account-subtitle').classList.add('hidden');
        }

        function handleCredentialResponse(response) {
            // Decode the JWT token
            const responsePayload = decodeJwtResponse(response.credential);
            
            // Store user data for authentication checking
            localStorage.setItem('googleUser', JSON.stringify(responsePayload));
            
            // Display user info
            displayUserInfo(responsePayload);
            
            console.log("ID: " + responsePayload.sub);
            console.log('Full Name: ' + responsePayload.name);
            console.log('Given Name: ' + responsePayload.given_name);
            console.log('Family Name: ' + responsePayload.family_name);
            console.log("Image URL: " + responsePayload.picture);
            console.log("Email: " + responsePayload.email);
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        async function signOut() {
            try {
                // Sign out from Firebase Auth
                await window.firebaseSignOut(window.auth);
            } catch (error) {
                console.log('Firebase sign out error (may not be signed in):', error);
            }
            
            // Clear Google Sign-In
            google.accounts.id.disableAutoSelect();
            
            // Hide user info and show auth forms
            document.getElementById('userInfo').classList.remove('show');
            document.querySelector('.g_id_signin').style.display = 'block';
            document.querySelector('.auth-container').classList.remove('hidden');
            document.querySelector('.account-subtitle').classList.remove('hidden');
            
            // Clear stored user data
            localStorage.removeItem('googleUser');
            
            // Reset forms
            showSignInForm();
            document.getElementById('signInEmail').value = '';
            document.getElementById('signInPassword').value = '';
            clearAuthMessage();
            
            console.log('User signed out successfully');
        }

        // Hamburger menu functions
        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');
            
            navMenu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function closeMenu() {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');
            
            navMenu.classList.remove('active');
            hamburger.classList.remove('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');
            const navbar = document.querySelector('.navbar');
            
            if (!navbar.contains(event.target) && navMenu.classList.contains('active')) {
                closeMenu();
            }
        });

        // Close menu on window resize if screen becomes larger
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMenu();
            }
        });

        function goToSavedDesigns() {
            window.location.href = 'saved-designs.html';
        }

        async function showOrdersModal() {
            // Try to load orders from Firebase first, then fallback to localStorage
            let orders = [];
            
            if (typeof loadOrdersFromFirebase === 'function') {
                try {
                    orders = await loadOrdersFromFirebase();
                    console.log('✅ Orders loaded from Firebase:', orders.length);
                } catch (error) {
                    console.error('❌ Failed to load orders from Firebase, using localStorage:', error);
                    orders = getOrders();
                }
            } else {
                orders = getOrders();
            }
            
            const googleUser = JSON.parse(localStorage.getItem('googleUser') || 'null');
            const userSub = googleUser?.sub || null;
            
            console.log('🔍 Order Debug Info:', {
                totalOrders: orders.length,
                userSub: userSub,
                userEmail: googleUser?.email,
                orders: orders.map(o => ({
                    id: o.id,
                    userSub: o.userSub,
                    userId: o.userId,
                    userEmail: o.userEmail,
                    status: o.status
                }))
            });
            
            const myOrders = orders.filter(o => {
                const matchesUserSub = o.userSub === userSub;
                const matchesUserId = o.userId === userSub;
                const matchesEmail = o.userEmail === googleUser?.email;
                
                console.log(`Order ${o.id}: userSub=${o.userSub}, userId=${o.userId}, email=${o.userEmail}, matches=${matchesUserSub || matchesUserId || matchesEmail}`);
                return matchesUserSub || matchesUserId || matchesEmail;
            });
            
            console.log('🔍 Filtered My Orders:', myOrders.length);
            console.log('🔍 My Orders Details:', myOrders.map(o => ({
                id: o.id,
                orderNumber: o.orderNumber,
                totalPrice: o.totalPrice,
                status: o.status,
                createdAt: o.createdAt
            })));

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <h2>My Orders</h2>
                    <button class="modal-btn modal-btn-secondary" style="position:absolute; top:10px; right:10px;" onclick="this.parentElement.parentElement.remove()">×</button>
                    ${myOrders.length === 0 ? '<p style="text-align:center; color:#666;">No orders yet.</p>' : ''}
                    <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                        ${myOrders.map(order => `
                            <div style="border:1px solid #ddd; border-radius:10px; padding:1rem; background:#f8f9fa;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                                    <strong>Order #${order.orderNumber || order.id}</strong>
                                    <span style="padding:0.2rem 0.6rem; border-radius:12px; background:#eee; font-size:0.8rem;">${order.status}</span>
                                </div>
                                <div style="font-size:0.9rem; color:#555; margin-bottom:0.5rem;">${new Date(order.createdAt || order.orderDate).toLocaleString()}</div>
                                <div style="font-size:0.9rem; color:#333; margin-bottom:0.5rem;">Total: $${(order.totalPrice || order.total).toFixed(2)}</div>
                                
                                <!-- Show purchased items -->
                                <div style="margin:0.5rem 0;">
                                    <strong style="font-size:0.9rem;">Items:</strong>
                                    <div style="margin-left:1rem; margin-top:0.25rem;">
                                        ${order.items.map(item => `
                                            <div style="font-size:0.8rem; color:#555; margin-bottom:0.25rem;">
                                                ${item.name || item.cardName} - $${(item.price || 0).toFixed(2)}
                                                ${item.type === 'custom' || item.editorType ? ' (Custom Card)' : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                ${order.shippingCompany ? `<div style="font-size:0.9rem; color:#333;">Shipped via ${order.shippingCompany} · Tracking: ${order.trackingNumber}</div>` : ''}
                                ${order.cancellationReason ? `<div style="font-size:0.9rem; color:#d63031; margin-top:0.5rem;"><strong>Cancellation Reason:</strong> ${order.cancellationReason}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showAddressManager() {
            const modal = document.createElement('div');
            modal.id = 'addressModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <h2>Manage Addresses</h2>
                    <div id="addressList"></div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-primary" onclick="addNewAddress()">Add New Address</button>
                        <button class="modal-btn modal-btn-secondary" onclick="closeAddressModal()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            loadAddresses();
        }

        function closeAddressModal() {
            const modal = document.getElementById('addressModal');
            if (modal) {
                modal.remove();
            }
        }

        function loadAddresses() {
            const addresses = getAddresses();
            const addressList = document.getElementById('addressList');
            
            if (addresses.length === 0) {
                addressList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No addresses saved yet. Add your first address!</p>';
                return;
            }
            
            addressList.innerHTML = addresses.map(addr => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa;">
                    <h4 style="margin-bottom: 0.5rem; color: #6a4c93;">${addr.name}</h4>
                    <p style="margin-bottom: 0.5rem;">${addr.streetAddress}</p>
                    <p style="margin-bottom: 0.5rem;">${addr.city}, ${addr.state} ${addr.zipCode}</p>
                    <p style="margin-bottom: 1rem;">${addr.country}</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm" onclick="editAddress(${addr.id})" style="background: #17a2b8; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer;">Edit</button>
                        <button class="btn btn-sm" onclick="deleteAddressForm(${addr.id})" style="background: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addNewAddress() {
            showAddressForm();
        }

        function editAddress(addressId) {
            const addresses = getAddresses();
            const address = addresses.find(addr => addr.id === addressId);
            if (address) {
                showAddressForm(address);
            }
        }

        function showAddressForm(address = null) {
            const modal = document.createElement('div');
            modal.id = 'addressFormModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>${address ? 'Edit Address' : 'Add New Address'}</h2>
                    <form id="addressForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Address Name:</label>
                            <input type="text" id="addressName" placeholder="e.g., Home, Work" value="${address ? address.name : ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Street Address:</label>
                            <input type="text" id="streetAddress" placeholder="123 Main St" value="${address ? address.streetAddress : ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">City:</label>
                            <input type="text" id="city" placeholder="New York" value="${address ? address.city : ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">State:</label>
                            <input type="text" id="state" placeholder="NY" value="${address ? address.state : ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ZIP Code:</label>
                            <input type="text" id="zipCode" placeholder="10001" value="${address ? address.zipCode : ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Country:</label>
                            <input type="text" id="country" placeholder="USA" value="${address ? address.country : ''}" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                    </form>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-primary" onclick="saveAddressForm(${address ? address.id : 'null'})">Save Address</button>
                        <button class="modal-btn modal-btn-secondary" onclick="closeAddressFormModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function closeAddressFormModal() {
            const modal = document.getElementById('addressFormModal');
            if (modal) {
                modal.remove();
            }
        }

        function saveAddressForm(addressId = null) {
            // Check if Firebase is offline
            if (window.isFirebaseOffline === true) {
                showFirebaseErrorMessage();
                return;
            }
            
            const name = document.getElementById('addressName').value.trim();
            const streetAddress = document.getElementById('streetAddress').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const zipCode = document.getElementById('zipCode').value.trim();
            const country = document.getElementById('country').value.trim();
            
            if (!name || !streetAddress || !city || !state || !zipCode || !country) {
                showModal('Missing Information', 'Please fill in all address fields! 📍');
                return;
            }
            
            const address = {
                id: addressId,
                name,
                streetAddress,
                city,
                state,
                zipCode,
                country
            };
            
            saveAddress(address);
            
            // Sync with Firebase
            if (window.firebaseService && window.firebaseService.currentUser) {
                const googleUser = localStorage.getItem('googleUser');
                const userData = JSON.parse(googleUser);
                firebaseService.saveAddressToFirebase(userData.sub, address);
            }
            
            closeAddressFormModal();
            loadAddresses();
            showModal('Success', 'Address saved successfully! 🏠✨');
        }

        function deleteAddressForm(addressId) {
            if (confirm('Are you sure you want to delete this address? This action cannot be undone! 🗑️')) {
                deleteAddress(addressId);
                loadAddresses();
                showModal('Success', 'Address deleted successfully! 🗑️✨');
            }
        }

        function goToCart() {
            const googleUser = localStorage.getItem('googleUser');
            if (!googleUser) {
                showSignInModal();
                return;
            }
            window.location.href = 'cart.html';
        }

        function showSignInModal() {
            showModal(
                'Sign In Required',
                'You need to sign in to access your cart. Please sign in to continue.',
                function() {
                    window.location.href = 'account.html';
                }
            );
        }

        function showModal(title, message, onConfirm = null) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('customModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2 id="modalTitle">Modal Title</h2>
                        <p id="modalMessage">Modal message goes here.</p>
                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-primary" id="modalConfirm">Confirm</button>
                            <button class="modal-btn modal-btn-secondary" id="modalCancel">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirm = document.getElementById('modalConfirm');
            const modalCancel = document.getElementById('modalCancel');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            if (onConfirm) {
                modalConfirm.style.display = 'inline-block';
                modalConfirm.onclick = function() {
                    onConfirm();
                    modal.style.display = 'none';
                };
            } else {
                modalConfirm.style.display = 'none';
            }

            modalCancel.onclick = function() {
                modal.style.display = 'none';
            };

            modal.style.display = 'flex';
        }

        // Security Questions and Forgot Password Functions
        
        function showForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'block';
            document.getElementById('forgotPasswordStep1').style.display = 'block';
            document.getElementById('forgotPasswordStep2').style.display = 'none';
            document.getElementById('forgotPasswordStep3').style.display = 'none';
        }
        
        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            // Clear form
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotSecurityAnswer1').value = '';
            document.getElementById('forgotSecurityAnswer2').value = '';
            document.getElementById('forgotSecurityAnswer3').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }
        
        async function checkSecurityQuestions() {
            const email = document.getElementById('forgotEmail').value;
            if (!email) {
                showAuthMessage('Please enter your email address');
                return;
            }
            
            console.log('🔍 Checking security questions for email:', email);
            console.log('🔍 Firebase service available:', !!window.firebaseService);
            console.log('🔍 Firebase service initialized:', window.firebaseService?.isInitialized);
            
            try {
                // Check if user exists and get security questions
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    console.log('🔍 Calling getSecurityQuestions...');
                    const securityQuestions = await window.firebaseService.getSecurityQuestions(email);
                    console.log('🔍 Security questions result:', securityQuestions);
                    
                    if (securityQuestions) {
                        // Populate the security questions
                        document.getElementById('securityQuestionLabel1').textContent = securityQuestions.question1;
                        document.getElementById('securityQuestionLabel2').textContent = securityQuestions.question2;
                        document.getElementById('securityQuestionLabel3').textContent = securityQuestions.question3;
                        
                        // Store the correct answers for verification
                        window.currentSecurityAnswers = {
                            answer1: securityQuestions.answer1,
                            answer2: securityQuestions.answer2,
                            answer3: securityQuestions.answer3
                        };
                        
                        // Show step 2
                        document.getElementById('forgotPasswordStep1').style.display = 'none';
                        document.getElementById('forgotPasswordStep2').style.display = 'block';
                        
                        // Populate answer options based on question type
                        populateAnswerOptions();
                        console.log('✅ Security questions loaded successfully');
                    } else {
                        showAuthMessage('No security questions found for this email address');
                    }
                } else {
                    showAuthMessage('Service not available. Please try again later.');
                }
            } catch (error) {
                console.error('Error checking security questions:', error);
                showAuthMessage('Error retrieving security questions: ' + error.message);
            }
        }
        
        function populateAnswerOptions() {
            // Get the question labels to determine what options to show
            const question1 = document.getElementById('securityQuestionLabel1').textContent;
            const question2 = document.getElementById('securityQuestionLabel2').textContent;
            const question3 = document.getElementById('securityQuestionLabel3').textContent;
            
            // Populate options for each question
            populateQuestionOptions('forgotSecurityAnswer1', question1);
            populateQuestionOptions('forgotSecurityAnswer2', question2);
            populateQuestionOptions('forgotSecurityAnswer3', question3);
        }
        
        function populateQuestionOptions(selectId, question) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select answer</option>';
            
            if (question.includes('month')) {
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    select.appendChild(option);
                });
            } else if (question.includes('color')) {
                const colors = ['Red', 'Blue', 'Green', 'Yellow', 'Purple', 'Orange', 
                              'Pink', 'Black', 'White', 'Gray', 'Brown'];
                colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    select.appendChild(option);
                });
            } else if (question.includes('personality')) {
                const personalities = ['Adventurous', 'Creative', 'Analytical', 'Compassionate', 
                                     'Independent', 'Organized', 'Spontaneous', 'Optimistic', 
                                     'Practical', 'Introverted', 'Extroverted'];
                personalities.forEach(personality => {
                    const option = document.createElement('option');
                    option.value = personality;
                    option.textContent = personality;
                    select.appendChild(option);
                });
            }
        }
        
        function verifySecurityAnswers() {
            const answer1 = document.getElementById('forgotSecurityAnswer1').value;
            const answer2 = document.getElementById('forgotSecurityAnswer2').value;
            const answer3 = document.getElementById('forgotSecurityAnswer3').value;
            
            if (!answer1 || !answer2 || !answer3) {
                showAuthMessage('Please answer all security questions');
                return;
            }
            
            if (window.currentSecurityAnswers) {
                if (answer1 === window.currentSecurityAnswers.answer1 &&
                    answer2 === window.currentSecurityAnswers.answer2 &&
                    answer3 === window.currentSecurityAnswers.answer3) {
                    // Correct answers - show password reset form
                    document.getElementById('forgotPasswordStep2').style.display = 'none';
                    document.getElementById('forgotPasswordStep3').style.display = 'block';
                } else {
                    showAuthMessage('Incorrect answers. Please try again.');
                }
            } else {
                showAuthMessage('Session expired. Please start over.');
            }
        }
        
        async function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!newPassword || !confirmNewPassword) {
                showAuthMessage('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showAuthMessage('Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showAuthMessage('Password must be at least 6 characters long');
                return;
            }
            
            try {
                const email = document.getElementById('forgotEmail').value;
                
                // Update password in Firebase
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    await window.firebaseService.updatePassword(email, newPassword);
                    showAuthMessage('Password updated successfully! You can now sign in with your new password.', 'success');
                    closeForgotPasswordModal();
                } else {
                    showAuthMessage('Service not available. Please try again later.');
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                showAuthMessage('Error updating password. Please try again.');
            }
        }
        
        async function showChangeSecurityQuestionsModal() {
            // Check if site is frozen
            if (await isSiteFrozen()) {
                showSiteFrozenMessage();
                return;
            }
            
            document.getElementById('changeSecurityQuestionsModal').style.display = 'block';
        }
        
        function closeChangeSecurityQuestionsModal() {
            document.getElementById('changeSecurityQuestionsModal').style.display = 'none';
            // Clear form
            document.getElementById('currentPasswordForSecurity').value = '';
            document.getElementById('newSecurityQuestion1').value = '';
            document.getElementById('newSecurityQuestion2').value = '';
            document.getElementById('newSecurityQuestion3').value = '';
        }
        
        async function updateSecurityQuestions() {
            // Check if Firebase is offline
            if (window.isFirebaseOffline === true) {
                showFirebaseErrorMessage();
                return;
            }
            
            const currentPassword = document.getElementById('currentPasswordForSecurity').value;
            const newAnswer1 = document.getElementById('newSecurityQuestion1').value;
            const newAnswer2 = document.getElementById('newSecurityQuestion2').value;
            const newAnswer3 = document.getElementById('newSecurityQuestion3').value;
            
            if (!currentPassword || !newAnswer1 || !newAnswer2 || !newAnswer3) {
                showAuthMessage('Please fill in all fields');
                return;
            }
            
            try {
                const userData = JSON.parse(localStorage.getItem('googleUser'));
                const email = userData.email;
                
                // Verify current password
                if (window.firebaseService && window.firebaseService.isInitialized) {
                    const isValidPassword = await window.firebaseService.verifyPassword(email, currentPassword);
                    if (isValidPassword) {
                        // Update security questions
                        const newSecurityQuestions = {
                            question1: 'What month were you born?',
                            answer1: newAnswer1,
                            question2: 'What is your favorite color?',
                            answer2: newAnswer2,
                            question3: 'What best describes your personality?',
                            answer3: newAnswer3
                        };
                        
                        await window.firebaseService.updateSecurityQuestions(userData.sub, newSecurityQuestions);
                        
                        // Update local storage
                        userData.securityQuestions = newSecurityQuestions;
                        localStorage.setItem('googleUser', JSON.stringify(userData));
                        
                        showAuthMessage('Security questions updated successfully!', 'success');
                        closeChangeSecurityQuestionsModal();
                    } else {
                        showAuthMessage('Incorrect current password');
                    }
                } else {
                    showAuthMessage('Service not available. Please try again later.');
                }
            } catch (error) {
                console.error('Error updating security questions:', error);
                showAuthMessage('Error updating security questions. Please try again.');
            }
        }

        // Site Freeze Functionality
        async function toggleSiteFreeze() {
            try {
                const isCurrentlyFrozen = await isSiteFrozen();
                const newFreezeState = !isCurrentlyFrozen;
                
                // Save freeze state to localStorage
                localStorage.setItem('siteFrozen', newFreezeState.toString());
                
                // Sync to Firebase if available
                if (window.firebaseService && 
                    window.firebaseService.isInitialized && 
                    typeof window.firebaseService.saveSiteFreezeState === 'function') {
                    
                    await window.firebaseService.saveSiteFreezeState(newFreezeState);
                }
                
                // Update button states
                updateFreezeButtonStates();
                
                // Show confirmation message
                const message = newFreezeState ? 
                    'Site has been frozen. Users will see maintenance messages.' : 
                    'Site has been unfrozen. All functionality restored.';
                showAuthMessage(message, 'success');
                
                console.log(`Site ${newFreezeState ? 'frozen' : 'unfrozen'} successfully`);
                
            } catch (error) {
                console.error('Error toggling site freeze:', error);
                if (isFirebaseError(error)) {
                    showFirebaseErrorMessage();
                } else {
                    showAuthMessage('Error updating site status. Please try again.');
                }
            }
        }

        async function isSiteFrozen() {
            try {
                // Check Firebase first if service is available and has the function
                if (window.firebaseService && 
                    window.firebaseService.isInitialized && 
                    typeof window.firebaseService.getSiteFreezeState === 'function') {
                    
                    const firebaseFreezeState = await window.firebaseService.getSiteFreezeState();
                    if (firebaseFreezeState !== null) {
                        return firebaseFreezeState;
                    }
                }
                
                // Fallback to localStorage
                return localStorage.getItem('siteFrozen') === 'true';
            } catch (error) {
                console.error('Error checking site freeze state:', error);
                // If Firebase error, show custom popup and fallback to localStorage
                if (isFirebaseError(error)) {
                    showFirebaseErrorMessage();
                }
                return localStorage.getItem('siteFrozen') === 'true';
            }
        }

        function updateFreezeButtonStates() {
            const freezeBtn = document.getElementById('freezeBtn');
            const unfreezeBtn = document.getElementById('unfreezeBtn');
            
            if (!freezeBtn || !unfreezeBtn) return;
            
            const isFrozen = localStorage.getItem('siteFrozen') === 'true';
            
            if (isFrozen) {
                freezeBtn.style.display = 'none';
                unfreezeBtn.style.display = 'block';
            } else {
                freezeBtn.style.display = 'block';
                unfreezeBtn.style.display = 'none';
            }
        }

        // Check site freeze state on page load
        window.addEventListener('load', async () => {
            if (typeof isAdmin === 'function' && isAdmin()) {
                updateFreezeButtonStates();
            }
        });

        function showSiteFrozenMessage() {
            alert("We're sorry, but our database is down. You cannot checkout, change account settings, or create accounts at this time.");
        }

        function showFirebaseErrorMessage() {
            showCustomErrorPopup("Our database is unavailable. Unfortunately, many functions are unavailable at this time.");
        }

        // Custom Error Popup
        function showCustomErrorPopup(message) {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Create popup content
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                text-align: center;
                position: relative;
            `;

            popup.innerHTML = `
                <div style="color: #dc3545; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                <h3 style="color: #dc3545; margin-bottom: 1rem; font-size: 1.3rem;">Service Unavailable</h3>
                <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.5;">${message}</p>
                <button onclick="this.closest('.error-popup-overlay').remove()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 0.8rem 2rem;
                    border-radius: 25px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: background 0.3s ease;
                " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                    OK
                </button>
            `;

            overlay.className = 'error-popup-overlay';
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        // Enhanced Firebase error detection
        function isFirebaseError(error) {
            if (!error) return false;
            
            const errorMessage = error.message ? error.message.toLowerCase() : '';
            const errorCode = error.code ? error.code.toLowerCase() : '';
            
            return errorMessage.includes('firebase') || 
                   errorMessage.includes('network') || 
                   errorMessage.includes('connection') ||
                   errorCode.includes('unavailable') ||
                   errorCode.includes('deadline') ||
                   errorCode.includes('aborted');
        }

        // Firebase Availability Check
        async function checkFirebaseAvailability() {
            try {
                let isAvailable = true;
                
                if (window.firebaseService && window.firebaseService.isInitialized && typeof window.firebaseService.checkFirebaseAvailability === 'function') {
                    isAvailable = await window.firebaseService.checkFirebaseAvailability();
                    updateOfflineIndicator(!isAvailable);
                    
                    if (!isAvailable) {
                        showFirebaseErrorMessage();
                    }
                } else {
                    // If Firebase service is not initialized, assume offline
                    isAvailable = false;
                    updateOfflineIndicator(true);
                }
                
                // Update database down banner
                const databaseDownBanner = document.getElementById('databaseDownBanner');
                if (databaseDownBanner) {
                    if (!isAvailable) {
                        databaseDownBanner.style.display = 'flex';
                    } else {
                        databaseDownBanner.style.display = 'none';
                    }
                }
                
                // Update global offline state
                window.isFirebaseOffline = !isAvailable;
                
                // Update button states
                updateButtonStates();
                
            } catch (error) {
                console.error('Error checking Firebase availability:', error);
                updateOfflineIndicator(true);
                showFirebaseErrorMessage();
                
                // Show database down banner on error
                const databaseDownBanner = document.getElementById('databaseDownBanner');
                if (databaseDownBanner) {
                    databaseDownBanner.style.display = 'flex';
                }
                window.isFirebaseOffline = true;
                
                // Update button states
                updateButtonStates();
            }
        }

        function updateOfflineIndicator(isOffline) {
            const offlineIndicator = document.getElementById('offlineIndicator');
            if (offlineIndicator) {
                offlineIndicator.style.display = isOffline ? 'block' : 'none';
            }
            
            // Store offline state globally
            window.isFirebaseOffline = isOffline;
        }
    </script>
</body>
</html>
